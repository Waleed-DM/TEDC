<!DOCTYPE html>
<html>
  <head>
    <title>Diabetes Progress Note TEDC</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
        line-height: 1.6;
        color: #333;
      }

      h1 {
        color: #2b73b7;
        border-bottom: 2px solid #2b73b7;
        padding-bottom: 10px;
        margin-bottom: 20px;
      }

      h2 {
        color: #2b73b7;
        margin-top: 25px;
        margin-bottom: 15px;
        padding-bottom: 5px;
        border-bottom: 1px solid #ddd;
      }

      h3 {
        color: #3a6ea5;
        margin-top: 20px;
        margin-bottom: 10px;
      }

      h4 {
        color: #4a7eb1;
        margin-top: 15px;
        margin-bottom: 8px;
        font-size: 0.95em;
      }

      .tab {
        overflow: hidden;
        border: 1px solid #ccc;
        background-color: #f1f1f1;
        border-radius: 5px 5px 0 0;
      }

      .tab button {
        background-color: inherit;
        float: left;
        border: none;
        outline: none;
        cursor: pointer;
        padding: 10px 16px;
        transition: 0.3s;
        font-weight: 500;
      }

      .tab button:hover {
        background-color: #ddd;
      }

      .tab button.active {
        background-color: #2b73b7;
        color: white;
      }

      .tabcontent {
        display: none;
        padding: 20px;
        border: 1px solid #ccc;
        border-top: none;
        border-radius: 0 0 5px 5px;
        background-color: white;
      }

      .section {
        margin-bottom: 20px;
        padding: 15px;
        background-color: #f9f9f9;
        border-radius: 5px;
        border-left: 4px solid #2b73b7;
      }

      .checkboxes {
        column-count: 2;
        column-gap: 20px;
        margin-top: 10px;
      }

      @media (max-width: 600px) {
        .checkboxes {
          column-count: 1;
        }
      }

      label {
        display: block;
        margin: 8px 0;
        cursor: pointer;
      }

      input[type="number"],
      input[type="text"],
      select {
        padding: 8px;
        margin-left: 5px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }

      textarea {
        width: 100%;
        height: 300px;
        margin-top: 20px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        resize: vertical;
      }

      button.generate {
        background: #2b73b7;
        color: white;
        border: none;
        padding: 12px 25px;
        margin-top: 20px;
        cursor: pointer;
        border-radius: 5px;
        font-weight: bold;
        font-size: 16px;
        transition: background 0.3s;
      }

      button.generate:hover {
        background: #1a5a8f;
      }

      .input-group {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
      }

      .input-group label {
        width: 180px;
        font-weight: 500;
      }

      .bmi-result {
        color: #2b73b7;
        font-weight: bold;
        margin-left: 10px;
      }

      .medication-group {
        border: 1px solid #ddd;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 5px;
        background-color: white;
      }

      .medication-row {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 10px;
        align-items: center;
      }

      .medication-name {
        width: 200px;
        min-width: 200px;
      }

      .medication-subtype-container {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .medication-subtype {
        width: 150px;
      }

      .medication-dose {
        width: 100px;
      }

      .medication-freq {
        width: 150px;
      }

      .medication-status {
        width: 150px;
        min-width: 150px;
      }

      .add-med-btn {
        background: #4caf50;
        color: white;
        border: none;
        padding: 8px 15px;
        cursor: pointer;
        border-radius: 5px;
        font-weight: 500;
        transition: background 0.3s;
      }

      .add-med-btn:hover {
        background: #3e8e41;
      }

      .remove-med-btn {
        background: #ff0000;
        color: white;
        border: none;
        padding: 5px 10px;
        cursor: pointer;
        border-radius: 3px;
        transition: background 0.3s;
      }

      .remove-med-btn:hover {
        background: #cc0000;
      }

      .glp1ra-option {
        font-weight: bold;
        color: #2b73b7;
      }

      .complication-group {
        margin-left: 10px;
        padding: 10px;
        background-color: #f0f0f0;
        border-radius: 5px;
      }

      .family-member {
        margin-bottom: 10px;
        padding: 10px;
        background-color: #f5f5f5;
        border-radius: 5px;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
      }

      .unit-conversion {
        font-size: 0.8em;
        color: #666;
        margin-left: 5px;
      }

      .investigation-row {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        flex-wrap: wrap;
      }

      .investigation-row label {
        width: 120px;
        font-weight: 500;
      }

      .investigation-input {
        width: 80px;
        margin-right: 5px;
      }

      .disabled-checkbox {
        opacity: 0.6;
        pointer-events: none;
      }

      .renal-function {
        background-color: #f0f8ff;
        padding: 15px;
        border-radius: 5px;
        margin-top: 15px;
        margin-bottom: 15px;
      }

      .acr-category {
        font-weight: bold;
        margin-left: 10px;
        color: #2b73b7;
      }

      .egfr-result {
        font-weight: bold;
        color: #2b73b7;
      }

      .thyroid-function {
        background-color: #fff0f5;
        padding: 15px;
        border-radius: 5px;
        margin-top: 15px;
        margin-bottom: 15px;
      }

      .liver-function {
        background-color: #f0fff0;
        padding: 15px;
        border-radius: 5px;
        margin-top: 15px;
        margin-bottom: 15px;
      }

      .hematology {
        background-color: #fffaf0;
        padding: 15px;
        border-radius: 5px;
        margin-top: 15px;
        margin-bottom: 15px;
      }

      .lipid-profile {
        background-color: #f5f0ff;
        padding: 15px;
        border-radius: 5px;
        margin-top: 15px;
        margin-bottom: 15px;
      }

      .unit-toggle {
        margin-left: 5px;
        font-size: 0.8em;
        color: #2b73b7;
        cursor: pointer;
        text-decoration: underline;
      }

      .anti-lipid-option {
        font-weight: bold;
        color: #8a2be2;
      }

      .glycemic-status {
        margin-left: 15px;
      }

      .insulin-therapy {
        display: none;
        margin-top: 20px;
        padding: 15px;
        background-color: #f5f5f5;
        border-radius: 5px;
      }

      .insulin-row {
        margin-bottom: 15px;
      }

      .insulin-option {
        margin-right: 15px;
      }

      input[type="radio"],
      input[type="checkbox"] {
        margin-right: 8px;
        transform: scale(1.1);
      }

      .radio-group,
      .checkbox-group {
        margin: 10px 0;
      }

      #progressNote {
        font-family: "Courier New", Courier, monospace;
        background-color: #f8f8f8;
        border: 1px solid #ddd;
        padding: 15px;
        line-height: 1.5;
      }

      @media (max-width: 768px) {
        .input-group label {
          width: 140px;
        }

        .medication-row {
          flex-direction: column;
          align-items: flex-start;
        }

        .medication-name,
        .medication-subtype,
        .medication-dose,
        .medication-freq,
        .medication-status {
          width: 100%;
          margin-bottom: 8px;
        }
      }
    </style>
  </head>
  <body>
    <h1>Diabetes Progress Note TEDC</h1>

    <div class="tab">
      <button class="tablinks active" onclick="openTab(event, 'History')">
        History
      </button>
      <button class="tablinks" onclick="openTab(event, 'Examination')">
        Examination
      </button>
      <button class="tablinks" onclick="openTab(event, 'Investigations')">
        Investigations
      </button>
      <button class="tablinks" onclick="openTab(event, 'AssessmentPlan')">
        Assessment & Plan
      </button>
    </div>

    <!-- History Tab -->
    <div id="History" class="tabcontent" style="display: block">
      <h2>History</h2>
      <div class="section">
        <div class="input-group">
          <label>Age:</label>
          <input type="number" id="patientAge" onchange="calculateEGFR()" />
        </div>
        <div class="input-group">
          <label>Gender:</label>
          <select id="patientGender" onchange="handleGenderChange()">
            <option value="">Select</option>
            <option value="Male">Male</option>
            <option value="Female">Female</option>
          </select>
        </div>

        <!-- Female-specific details section -->
        <div class="section" id="femaleDetailsSection" style="display: none">
          <h3>Female-Specific Details</h3>
          <div class="checkboxes">
            <label><input type="checkbox" id="isMarried" /> Married</label>
            <label><input type="checkbox" id="isPregnant" /> Pregnant</label>
            <label><input type="checkbox" id="isLactating" /> Lactating</label>
            <label
              ><input type="checkbox" id="planningPregnancy" /> Planning
              Pregnancy</label
            >
          </div>
        </div>

        <div class="input-group">
          <label>Duration of Diagnosis:</label>
          <input
            type="text"
            id="diagnosisDuration"
            placeholder="e.g., 5 years"
          />
        </div>
      </div>

      <div class="section">
        <h3>Diabetes Type</h3>
        <div class="checkboxes">
          <label
            ><input
              type="checkbox"
              class="diabetesType"
              value="Type 1"
              onchange="toggleInsulinTherapy()"
            />
            Type 1</label
          >
          <label
            ><input
              type="checkbox"
              class="diabetesType"
              value="Type 2"
              onchange="toggleInsulinTherapy()"
            />
            Type 2</label
          >
          <label
            ><input
              type="checkbox"
              class="diabetesType"
              value="GDM"
              onchange="toggleInsulinTherapy()"
            />
            GDM</label
          >
          <label
            ><input
              type="checkbox"
              class="diabetesType"
              value="Other"
              onchange="toggleInsulinTherapy()" />
            Other: <input type="text" id="diabetesTypeOther"
          /></label>
        </div>
      </div>

      <div class="section">
        <h3>Other Medical History</h3>
        <div class="checkboxes">
          <label
            ><input type="checkbox" class="otherHistory" value="Hypertension" />
            Hypertension</label
          >
          <label
            ><input type="checkbox" class="otherHistory" value="Dyslipidemia" />
            Dyslipidemia</label
          >
          <label
            ><input type="checkbox" class="otherHistory" value="Obesity" />
            Obesity</label
          >
          <label
            ><input
              type="checkbox"
              class="otherHistory"
              value="Hypothyroidism"
            />
            Hypothyroidism</label
          >
          <label
            ><input type="checkbox" class="otherHistory" value="Osteoporosis" />
            Osteoporosis</label
          >
          <label
            ><input type="checkbox" class="otherHistory" value="Other" /> Other:
            <input type="text" id="otherHistoryText"
          /></label>
        </div>
      </div>

      <div class="section">
        <h3>Family History of Diabetes</h3>
        <div id="familyHistoryContainer">
          <div class="family-member">
            <select class="family-relation">
              <option value="">Select family member</option>
              <option value="Mother">Mother</option>
              <option value="Father">Father</option>
              <option value="Sibling">Sibling</option>
              <option value="Grandparent">Grandparent</option>
              <option value="Aunt/Uncle">Aunt/Uncle</option>
              <option value="Child">Child</option>
            </select>
            <select class="family-diabetes-type">
              <option value="">Type of diabetes</option>
              <option value="Type 1">Type 1</option>
              <option value="Type 2">Type 2</option>
              <option value="GDM">GDM</option>
              <option value="Other">Other</option>
            </select>
            <input
              type="text"
              class="family-age-diagnosis"
              placeholder="Age at diagnosis"
              style="width: 120px"
            />
            <button class="remove-med-btn" onclick="removeFamilyMember(this)">
              Remove
            </button>
          </div>
        </div>
        <button class="add-med-btn" onclick="addFamilyMember()">
          + Add Family Member
        </button>
      </div>

      <div class="section">
        <h3>Diabetes Complications</h3>
        <div class="complication-group">
          <label>
            <input
              type="checkbox"
              class="complication"
              value="No complications"
              id="noComplicationsCheckbox"
              onchange="toggleComplications(this)"
            />
            No complications
          </label>

          <h4>Microvascular Complications</h4>
          <div class="checkboxes">
            <label
              ><input
                type="checkbox"
                class="complication micro"
                value="Retinopathy"
              />
              Retinopathy</label
            >
            <label
              ><input
                type="checkbox"
                class="complication micro"
                value="Nephropathy"
              />
              Nephropathy</label
            >
            <label
              ><input
                type="checkbox"
                class="complication micro"
                value="Neuropathy"
              />
              Neuropathy</label
            >
            <label
              ><input
                type="checkbox"
                class="complication micro"
                value="Diabetic foot"
              />
              Diabetic foot</label
            >
          </div>

          <h4>Macrovascular Complications</h4>
          <div class="checkboxes">
            <label
              ><input type="checkbox" class="complication macro" value="CAD" />
              Coronary Artery Disease</label
            >
            <label
              ><input type="checkbox" class="complication macro" value="PAD" />
              Peripheral Artery Disease</label
            >
            <label
              ><input
                type="checkbox"
                class="complication macro"
                value="Stroke"
              />
              Stroke/TIA</label
            >
          </div>

          <h4>Other Complications</h4>
          <div class="checkboxes">
            <label
              ><input type="checkbox" class="complication other" value="DKA" />
              DKA</label
            >
            <label
              ><input type="checkbox" class="complication other" value="HHS" />
              HHS</label
            >
            <label
              ><input
                type="checkbox"
                class="complication other"
                value="Hypoglycemia"
              />
              Severe Hypoglycemia</label
            >
            <label
              ><input
                type="checkbox"
                class="complication other"
                value="Other" />
              Other: <input type="text" id="complicationOther"
            /></label>
          </div>
        </div>
      </div>

      <div class="section">
        <h3>Hypoglycemia History</h3>
        <div class="radio-group">
          <h4>Frequency:</h4>
          <label
            ><input
              type="radio"
              name="hypoFrequency"
              value="Rare (1-3/month)"
            />
            Rare (1-3/month)</label
          >
          <label
            ><input
              type="radio"
              name="hypoFrequency"
              value="Frequent (1-3/week)"
            />
            Frequent (1-3/week)</label
          >
          <label
            ><input
              type="radio"
              name="hypoFrequency"
              value="Most of the Days"
            />
            Most of the Days</label
          >
        </div>

        <div class="radio-group">
          <h4>Presence of Symptoms:</h4>
          <label
            ><input type="radio" name="hypoSymptoms" value="Yes" /> Yes</label
          >
          <label
            ><input type="radio" name="hypoSymptoms" value="No" /> No</label
          >
        </div>

        <div class="checkbox-group">
          <h4>Timing of Hypoglycemia:</h4>
          <div class="checkboxes" style="column-count: 3">
            <label
              ><input
                type="checkbox"
                class="hypoTiming"
                value="Pre-breakfast"
              />
              Pre-breakfast</label
            >
            <label
              ><input type="checkbox" class="hypoTiming" value="Pre-lunch" />
              Pre-lunch</label
            >
            <label
              ><input type="checkbox" class="hypoTiming" value="Pre-dinner" />
              Pre-dinner</label
            >
            <label
              ><input
                type="checkbox"
                class="hypoTiming"
                value="Post-breakfast"
              />
              Post-breakfast</label
            >
            <label
              ><input type="checkbox" class="hypoTiming" value="Post-lunch" />
              Post-lunch</label
            >
            <label
              ><input type="checkbox" class="hypoTiming" value="Post-dinner" />
              Post-dinner</label
            >
            <label
              ><input type="checkbox" class="hypoTiming" value="Late Night" />
              Late Night</label
            >
            <label
              ><input
                type="checkbox"
                class="hypoTiming"
                value="Early Morning"
              />
              Early Morning</label
            >
            <label
              ><input type="checkbox" class="hypoTiming" value="Mid night" />
              Mid night</label
            >
            <label
              ><input
                type="checkbox"
                class="hypoTiming"
                value="Post Correction Doses"
              />
              Post Correction Doses</label
            >
          </div>
        </div>
      </div>

      <div class="section">
        <h3>Current Medications</h3>
        <div id="medication-container">
          <div class="medication-group">
            <div class="medication-row">
              <select
                class="medication-name"
                onchange="updateMedicationOptions(this)"
              >
                <option value="">Select Medication</option>
                <option value="Metformin">Metformin</option>
                <option value="Insulin">Insulin</option>
                <option value="GLP-1 RA">GLP-1 RA</option>
                <option value="SGLT2i">SGLT2 Inhibitors</option>
                <option value="DPP-4i">DPP-4 Inhibitors</option>
                <option value="Sulfonylurea">Sulfonylurea</option>
                <option value="TZD">TZD (Thiazolidinediones)</option>
                <option value="ARB">ARB (Angiotensin Receptor Blocker)</option>
                <option value="ACEi">ACE Inhibitor</option>
                <option value="CCB">Calcium Channel Blocker</option>
                <option value="Beta Blocker">Beta Blocker</option>
                <option value="Thiazide">Thiazide Diuretic</option>
                <option value="Aspirin">Aspirin</option>
                <option value="Clopidogrel">Clopidogrel</option>
                <option value="Anti-Lipid">Anti-Lipid Medications</option>
                <option value="Levothyroxine">Levothyroxine</option>
                <option value="Other">Other</option>
              </select>

              <div class="medication-subtype-container">
                <select class="medication-subtype" style="display: none">
                  <option value="">Select Type</option>
                </select>
              </div>

              <input type="text" class="medication-dose" placeholder="Dose" />

              <select class="medication-freq">
                <option value="">Frequency</option>
                <option value="Once daily">Once daily</option>
                <option value="Twice daily">Twice daily</option>
                <option value="Three times daily">Three times daily</option>
                <option value="With meals">With meals</option>
                <option value="At bedtime">At bedtime</option>
                <option value="Every 2 weeks">Every 2 weeks</option>
                <option value="Other">Other</option>
              </select>

              <button class="remove-med-btn" onclick="removeMedication(this)">
                Remove
              </button>
            </div>
          </div>
        </div>
        <button class="add-med-btn" onclick="addMedication()">
          + Add Medication
        </button>
      </div>

      <div class="section" id="insulinTherapySection" style="display: none">
        <h3>Insulin Therapy Details</h3>

        <div class="insulin-row">
          <label
            ><input type="checkbox" id="carbCounting" /> Does Patient Carb
            Count?</label
          >
          <div
            id="carbCountingDetails"
            style="margin-left: 20px; display: none"
          >
            <label>ICR (Insulin-to-Carb Ratio):</label>
            <span id="icrResult" class="bmi-result">Not calculated</span>
            <input
              type="text"
              id="customICR"
              placeholder="Custom ICR (e.g., 1:10)"
              style="margin-left: 10px"
            />
          </div>
        </div>

        <div class="insulin-row">
          <label>Insulin Sensitivity Factor (ISF):</label>
          <span id="isfResult" class="bmi-result">Not calculated</span>
          <input
            type="text"
            id="customISF"
            placeholder="Custom ISF (e.g., 1:50)"
            style="margin-left: 10px"
          />
        </div>

        <div class="insulin-row">
          <label>Total Daily Dose (TDD):</label>
          <span id="tddResult" class="bmi-result">Not calculated</span>
        </div>

        <div class="insulin-row">
          <label>Timing of injection:</label>
          <div style="display: inline-block; margin-left: 10px">
            <label class="insulin-option"
              ><input
                type="radio"
                name="injectionTiming"
                value="Before Meal Time"
              />
              Before Meal Time</label
            >
            <label class="insulin-option"
              ><input
                type="radio"
                name="injectionTiming"
                value="At Meal Time"
              />
              At Meal Time</label
            >
            <label class="insulin-option"
              ><input
                type="radio"
                name="injectionTiming"
                value="After Meal Time"
              />
              After Meal Time</label
            >
          </div>
        </div>

        <div class="insulin-row">
          <label>Technique and Site of Injection:</label>
          <textarea
            id="injectionTechnique"
            style="width: 300px; height: 60px; margin-left: 10px"
          ></textarea>
        </div>
      </div>

      <div class="section">
        <h3>Screening History</h3>
        <div class="radio-group">
          <h4>Foot Screening:</h4>
          <label
            ><input type="radio" name="footScreening" value="Done" />
            Done</label
          >
          <label
            ><input type="radio" name="footScreening" value="Not Done" /> Not
            Done</label
          >
        </div>

        <div class="radio-group">
          <h4>Retina Screening:</h4>
          <label
            ><input type="radio" name="retinaScreening" value="Done" />
            Done</label
          >
          <label
            ><input type="radio" name="retinaScreening" value="Not Done" /> Not
            Done</label
          >
        </div>

        <div class="radio-group">
          <h4>Kidney Screening:</h4>
          <label
            ><input type="radio" name="kidneyScreening" value="Done" />
            Done</label
          >
          <label
            ><input type="radio" name="kidneyScreening" value="Not Done" /> Not
            Done</label
          >
        </div>
      </div>

      <div class="section">
        <h3>Lifestyle History</h3>
        <div class="radio-group">
          <h4>Smoking Status:</h4>
          <label
            ><input type="radio" name="smokingStatus" value="Smoker" />
            Smoker</label
          >
          <label
            ><input type="radio" name="smokingStatus" value="Ex-Smoker" />
            Ex-Smoker</label
          >
          <label
            ><input type="radio" name="smokingStatus" value="Non-Smoker" />
            Non-Smoker</label
          >
        </div>

        <div class="radio-group">
          <h4>Adherence on Treatment:</h4>
          <label
            ><input type="radio" name="treatmentAdherence" value="Poor" />
            Poor</label
          >
          <label
            ><input type="radio" name="treatmentAdherence" value="Good" />
            Good</label
          >
        </div>

        <div class="radio-group">
          <h4>Diet:</h4>
          <label><input type="radio" name="diet" value="Poor" /> Poor</label>
          <label><input type="radio" name="diet" value="Good" /> Good</label>
        </div>

        <div class="radio-group">
          <h4>Physical Activity:</h4>
          <label
            ><input type="radio" name="physicalActivity" value="Active" />
            Active</label
          >
          <label
            ><input type="radio" name="physicalActivity" value="Inactive" />
            Inactive</label
          >
        </div>

        <div class="radio-group">
          <h4>Vaccination Status:</h4>
          <label
            ><input
              type="radio"
              name="vaccinationStatus"
              value="Took Last Vaccines"
            />
            Took Last Vaccines</label
          >
          <label
            ><input
              type="radio"
              name="vaccinationStatus"
              value="Vaccines not Taken"
            />
            Vaccines not Taken</label
          >
        </div>
      </div>
    </div>

    <!-- Examination Tab -->
    <div id="Examination" class="tabcontent">
      <h2>Examination</h2>
      <div class="section">
        <div class="input-group">
          <label>Weight (kg):</label>
          <input
            type="number"
            id="weight"
            step="0.1"
            onchange="calculateBMI()"
          />
        </div>
        <div class="input-group">
          <label>Height (cm):</label>
          <input
            type="number"
            id="height"
            step="0.1"
            onchange="calculateBMI()"
          />
        </div>
        <div class="input-group">
          <label>BMI:</label>
          <span id="bmiResult" class="bmi-result">-</span>
          <input type="hidden" id="bmi" />
        </div>
        <div class="input-group">
          <label>Blood Pressure:</label>
          <input type="text" id="bp" placeholder="e.g., 120/80" />
        </div>
      </div>
    </div>

    <!-- Investigations Tab -->
    <div id="Investigations" class="tabcontent">
      <h2>Investigations</h2>

      <div class="section">
        <h3>Laboratory Results</h3>

        <div class="investigation-row">
          <label>HbA1c (%):</label>
          <input
            type="number"
            id="hba1c"
            step="0.1"
            class="investigation-input"
          />
          <span class="unit-conversion" id="hba1c-mmol"></span>
        </div>

        <div class="investigation-row">
          <label>FBS:</label>
          <input type="number" id="fbs" class="investigation-input" />
          <select id="fbs-unit" onchange="convertGlucoseUnits()">
            <option value="mg/dL">mg/dL</option>
            <option value="mmol/L">mmol/L</option>
          </select>
          <span class="unit-conversion" id="fbs-converted"></span>
        </div>

        <div class="renal-function">
          <h4>Renal Function</h4>
          <div class="investigation-row">
            <label>Creatinine:</label>
            <input
              type="number"
              id="creatinine"
              class="investigation-input"
              step="0.01"
              onchange="calculateEGFR()"
            />
            <select id="creatinine-unit" onchange="convertCreatinineUnits()">
              <option value="mg/dL">mg/dL</option>
              <option value="μmol/L">μmol/L</option>
            </select>
            <span class="unit-conversion" id="creatinine-converted"></span>
          </div>
          <div class="investigation-row">
            <label>eGFR (mL/min/1.73m²):</label>
            <span id="egfr-result" class="egfr-result">-</span>
            <input type="hidden" id="egfr" />
          </div>
          <div class="investigation-row">
            <label>ACR:</label>
            <input
              type="number"
              id="acr"
              class="investigation-input"
              onchange="updateACRCategory()"
            />
            <select id="acr-unit" onchange="convertACRUnits()">
              <option value="mg/g">mg/g</option>
              <option value="mg/mmol">mg/mmol</option>
            </select>
            <span class="unit-conversion" id="acr-converted"></span>
            <span id="acr-category" class="acr-category"></span>
          </div>
        </div>

        <div class="liver-function">
          <h4>Liver Function</h4>
          <div class="investigation-row">
            <label>ALT (U/L):</label>
            <input type="number" id="alt" class="investigation-input" />
          </div>
          <div class="investigation-row">
            <label>AST (U/L):</label>
            <input type="number" id="ast" class="investigation-input" />
          </div>
        </div>

        <div class="hematology">
          <h4>Hematology</h4>
          <div class="investigation-row">
            <label>Hemoglobin:</label>
            <input
              type="number"
              id="hb"
              class="investigation-input"
              step="0.1"
            />
            <select id="hb-unit" onchange="convertHemoglobinUnits()">
              <option value="g/dL">g/dL</option>
              <option value="mmol/L">mmol/L</option>
            </select>
            <span class="unit-conversion" id="hb-converted"></span>
          </div>
        </div>

        <div class="thyroid-function">
          <h4>Thyroid Function</h4>
          <div class="investigation-row">
            <label>TSH (mIU/L):</label>
            <input
              type="number"
              id="tsh"
              class="investigation-input"
              step="0.01"
            />
          </div>
          <div class="investigation-row">
            <label>FT4:</label>
            <input
              type="number"
              id="ft4"
              class="investigation-input"
              step="0.01"
            />
            <select id="ft4-unit" onchange="convertFT4Units()">
              <option value="ng/dL">ng/dL</option>
              <option value="pmol/L">pmol/L</option>
            </select>
            <span class="unit-conversion" id="ft4-converted"></span>
          </div>
          <div class="investigation-row">
            <label>FT3:</label>
            <input
              type="number"
              id="ft3"
              class="investigation-input"
              step="0.01"
            />
            <select id="ft3-unit" onchange="convertFT3Units()">
              <option value="pg/mL">pg/mL</option>
              <option value="pmol/L">pmol/L</option>
            </select>
            <span class="unit-conversion" id="ft3-converted"></span>
          </div>
        </div>

        <div class="lipid-profile">
          <h4>Lipid Profile</h4>
          <div class="investigation-row">
            <label>LDL:</label>
            <input type="number" id="ldl" class="investigation-input" />
            <select id="ldl-unit" onchange="convertLDLUnits()">
              <option value="mg/dL">mg/dL</option>
              <option value="mmol/L">mmol/L</option>
            </select>
            <span class="unit-conversion" id="ldl-converted"></span>
          </div>

          <div class="investigation-row">
            <label>HDL:</label>
            <input type="number" id="hdl" class="investigation-input" />
            <select id="hdl-unit" onchange="convertHDLUnits()">
              <option value="mg/dL">mg/dL</option>
              <option value="mmol/L">mmol/L</option>
            </select>
            <span class="unit-conversion" id="hdl-converted"></span>
          </div>

          <div class="investigation-row">
            <label>TG:</label>
            <input type="number" id="tg" class="investigation-input" />
            <select id="tg-unit" onchange="convertTGUnits()">
              <option value="mg/dL">mg/dL</option>
              <option value="mmol/L">mmol/L</option>
            </select>
            <span class="unit-conversion" id="tg-converted"></span>
          </div>

          <div class="investigation-row">
            <label>Total Cholesterol:</label>
            <input type="number" id="totalChol" class="investigation-input" />
            <select id="totalChol-unit" onchange="convertTotalCholUnits()">
              <option value="mg/dL">mg/dL</option>
              <option value="mmol/L">mmol/L</option>
            </select>
            <span class="unit-conversion" id="totalChol-converted"></span>
          </div>
        </div>
      </div>

      <div class="section">
        <h3>Radiology Reports</h3>
        <textarea
          id="radiology"
          placeholder="Enter radiology findings"
          style="width: 100%; height: 100px"
        ></textarea>
      </div>
    </div>

    <!-- Assessment and Plan Tab -->
    <div id="AssessmentPlan" class="tabcontent">
      <h2>Assessment and Plan</h2>

      <div class="section">
        <h3>Assessment</h3>
        <div class="glycemic-status">
          <h4>Glycemic Status:</h4>
          <label
            ><input
              type="radio"
              name="glycemicStatus"
              value="Strict HbA1c/TIR with Frequent Hypoglycemia"
            />
            Strict HbA1c/TIR with Frequent Hypoglycemia</label
          >
          <label
            ><input
              type="radio"
              name="glycemicStatus"
              value="Reasonable HbA1c/TIR"
            />
            Reasonable HbA1c/TIR</label
          >
          <label
            ><input
              type="radio"
              name="glycemicStatus"
              value="Suboptimal HbA1c/TIR"
            />
            Suboptimal HbA1c/TIR</label
          >
          <label
            ><input
              type="radio"
              name="glycemicStatus"
              value="Improved HbA1c/TIR but Still Uncontrolled"
            />
            Improved HbA1c/TIR but Still Uncontrolled</label
          >
          <label
            ><input
              type="radio"
              name="glycemicStatus"
              value="Deteriorated HbA1c/TIR"
            />
            Deteriorated HbA1c/TIR</label
          >
        </div>
      </div>

      <div class="section">
        <h3>Treatment Plan</h3>
        <button class="add-med-btn" onclick="populateFromCurrentMeds()">
          Copy Current Medications to Plan
        </button>
        <div id="newMeds-container">
          <div class="medication-group">
            <div class="medication-row">
              <select
                class="medication-name"
                onchange="updateMedicationOptions(this)"
              >
                <option value="">Select Medication</option>
                <option value="Metformin">Metformin</option>
                <option value="Insulin">Insulin</option>
                <option value="GLP-1 RA">GLP-1 RA</option>
                <option value="SGLT2i">SGLT2 Inhibitors</option>
                <option value="DPP-4i">DPP-4 Inhibitors</option>
                <option value="Sulfonylurea">Sulfonylurea</option>
                <option value="TZD">TZD (Thiazolidinediones)</option>
                <option value="ARB">ARB (Angiotensin Receptor Blocker)</option>
                <option value="ACEi">ACE Inhibitor</option>
                <option value="CCB">Calcium Channel Blocker</option>
                <option value="Beta Blocker">Beta Blocker</option>
                <option value="Thiazide">Thiazide Diuretic</option>
                <option value="Aspirin">Aspirin</option>
                <option value="Clopidogrel">Clopidogrel</option>
                <option value="Anti-Lipid">Anti-Lipid Medications</option>
                <option value="Levothyroxine">Levothyroxine</option>
                <option value="Other">Other</option>
              </select>

              <div class="medication-subtype-container">
                <select class="medication-subtype" style="display: none">
                  <option value="">Select Type</option>
                </select>
              </div>

              <input type="text" class="medication-dose" placeholder="Dose" />

              <select class="medication-freq">
                <option value="">Frequency</option>
                <option value="Once daily">Once daily</option>
                <option value="Twice daily">Twice daily</option>
                <option value="Three times daily">Three times daily</option>
                <option value="With meals">With meals</option>
                <option value="At bedtime">At bedtime</option>
                <option value="Every week">Every week</option>
                <option value="Every 2 weeks">Every 2 weeks</option>
                <option value="Other">Other</option>
              </select>

              <select class="medication-status">
                <option value="Continue">Continue</option>
                <option value="Discontinue">Discontinue</option>
                <option value="Increase Dose">Increase Dose</option>
                <option value="Decrease Dose">Decrease Dose</option>
                <option value="Change Frequency">Change Frequency</option>
              </select>

              <button
                class="remove-med-btn"
                onclick="removeNewMedication(this)"
              >
                Remove
              </button>
            </div>
          </div>
        </div>
        <button class="add-med-btn" onclick="addNewMedication()">
          + Add Medication
        </button>
      </div>

      <div class="section">
        <h3>Lifestyle Recommendations</h3>
        <div class="checkboxes">
          <label
            ><input
              type="checkbox"
              class="lifestyle"
              value="Dietary counseling"
            />
            Dietary counseling</label
          >
          <label
            ><input type="checkbox" class="lifestyle" value="Exercise plan" />
            Exercise plan</label
          >
          <label
            ><input type="checkbox" class="lifestyle" value="Other" /> Other:
            <input type="text" id="lifestyleOther"
          /></label>
        </div>
      </div>

      <div class="section">
        <h3>Doctor Recommendations</h3>
        <textarea
          id="doctorRecommendations"
          placeholder="Enter doctor's recommendations here..."
          style="width: 100%; height: 100px"
        >
        </textarea>
      </div>

      <div class="section">
        <h3>Orders and Referrals</h3>
        <div class="checkboxes" style="column-count: 2">
          <label
            ><input
              type="checkbox"
              class="referral"
              value="Discharge patient to PHC"
            />
            Discharge patient to PHC</label
          >
          <label
            ><input
              type="checkbox"
              class="referral"
              value="Refer Patient to Educator"
            />
            Refer Patient to Educator</label
          >
          <label
            ><input
              type="checkbox"
              class="referral"
              value="Refer Patient to Nutritionist"
            />
            Refer Patient to Nutritionist</label
          >
          <label
            ><input
              type="checkbox"
              class="referral"
              value="Refer Patient to DM Foot Clinic"
            />
            Refer Patient to DM Foot Clinic</label
          >
          <label
            ><input
              type="checkbox"
              class="referral"
              value="Refer Patient to Kidney Center"
            />
            Refer Patient to Kidney Center</label
          >
          <label
            ><input
              type="checkbox"
              class="referral"
              value="Refer Patient to OPH Clinic"
            />
            Refer Patient to OPH Clinic</label
          >
          <label
            ><input
              type="checkbox"
              class="referral"
              value="Refer Patient to Social Worker"
            />
            Refer Patient to Social Worker</label
          >
          <label
            ><input
              type="checkbox"
              class="referral"
              value="Refer Patient to Psychiatry Clinic"
            />
            Refer Patient to Psychiatry Clinic</label
          >
          <label
            ><input
              type="checkbox"
              class="referral"
              value="Refer Patient to Neurology Clinic"
            />
            Refer Patient to Neurology Clinic</label
          >
          <label
            ><input
              type="checkbox"
              class="referral"
              value="Refer Patient to Impotence Clinic"
            />
            Refer Patient to Impotence Clinic</label
          >
        </div>
      </div>

      <div class="section">
        <h3>Instructions to Educator</h3>
        <div class="checkboxes">
          <label
            ><input
              type="checkbox"
              class="educatorInstruction"
              value="Instruct Patient how to adjust basal insulin every 3 days based on Fasting BG target 80-130 mg/dl"
            />
            Instruct Patient how to adjust basal insulin every 3 days based on
            Fasting BG target 80-130 mg/dl</label
          >
          <label
            ><input
              type="checkbox"
              class="educatorInstruction"
              value="Instruct Patient how to adjust Pre-meal Insulin Doses every 2 days based on 2h-Post-meals target 140 - 180 mg/dl"
            />
            Instruct Patient how to adjust Pre-meal Insulin Doses every 2 days
            based on 2h-Post-meals target 140 - 180 mg/dl</label
          >
          <label
            ><input
              type="checkbox"
              class="educatorInstruction"
              value="Instruct patient how to use Insulin Correction dose with ISF"
            />
            Instruct patient how to use Insulin Correction dose with ISF</label
          >
          <label
            ><input
              type="checkbox"
              class="educatorInstruction"
              value="Instruct Patient how to use Ozempic Medication"
            />
            Instruct Patient how to use Ozempic Medication</label
          >
          <label
            ><input
              type="checkbox"
              class="educatorInstruction"
              value="Instruct Patient how to use Trulicity"
            />
            Instruct Patient how to use Trulicity</label
          >
          <label
            ><input
              type="checkbox"
              class="educatorInstruction"
              value="Instruct Patient how to use Soliqua (within 1 hour before main time)"
            />
            Instruct Patient how to use Soliqua (within 1 hour before main
            time)</label
          >
          <label
            ><input
              type="checkbox"
              class="educatorInstruction"
              value="Encourage Physical Activity"
            />
            Encourage Physical Activity</label
          >
          <label
            ><input
              type="checkbox"
              class="educatorInstruction"
              value="Instruct Patient to monitor blood glucose regularly"
            />
            Instruct Patient to monitor blood glucose regularly</label
          >
          <label
            ><input
              type="checkbox"
              class="educatorInstruction"
              value="FU with the Patient weekly to ensure he/she is able to follow the instructions"
            />
            FU with the Patient weekly to ensure he/she is able to follow the
            instructions</label
          >
        </div>
      </div>

      <div class="section">
        <h3>Nutritionist Instructions</h3>
        <div class="checkboxes">
          <label
            ><input
              type="checkbox"
              class="nutritionistInstruction"
              value="Instruct Patient to follow Low Carb Diet"
            />
            Instruct Patient to follow Low Carb Diet</label
          >
          <label
            ><input
              type="checkbox"
              class="nutritionistInstruction"
              value="Instruct Patient to Avoid Excessive Carb intake"
            />
            Instruct Patient to Avoid Excessive Carb intake</label
          >
          <label
            ><input
              type="checkbox"
              class="nutritionistInstruction"
              value="Instruct Patient to learn Carb Count"
            />
            Instruct Patient to learn Carb Count</label
          >
          <label
            ><input
              type="checkbox"
              class="nutritionistInstruction"
              value="Instruct Patient to learn Carb Count with ICR"
            />
            Instruct Patient to learn Carb Count with ICR</label
          >
          <label
            ><input
              type="checkbox"
              class="nutritionistInstruction"
              value="FU with the Patient weekly to ensure he/she is able to follow the instructions"
            />
            FU with the Patient weekly to ensure he/she is able to follow the
            instructions</label
          >
        </div>
      </div>
    </div>

    <button class="generate" onclick="generateNote()">
      Generate Progress Note
    </button>

    <h2>Progress Note</h2>
    <textarea id="progressNote" readonly></textarea>

    <script>
      // Add this new function to handle gender changes
      function handleGenderChange() {
        calculateEGFR();
        // Show female details section only if gender is female
        document.getElementById("femaleDetailsSection").style.display =
          document.getElementById("patientGender").value === "Female"
            ? "block"
            : "none";
      }

      // Update the gender select to use the new handler
      document.getElementById("patientGender").onchange = handleGenderChange;

      // Input validation helper
      function validateNumberInput(input, min = 0, max = 999) {
        const value = parseFloat(input.value);
        if (isNaN(value) || value < min || value > max) {
          input.style.border = "1px solid red";
          return false;
        }
        input.style.border = "";
        return true;
      }

      // Apply validation to key fields
      document
        .getElementById("patientAge")
        .addEventListener("blur", function () {
          validateNumberInput(this, 1, 120);
        });

      document.getElementById("weight").addEventListener("blur", function () {
        validateNumberInput(this, 10, 300);
      });

      document.getElementById("height").addEventListener("blur", function () {
        validateNumberInput(this, 50, 250);
      });

      // Lab value validation
      document
        .querySelectorAll(
          "#hba1c, #fbs, #ldl, #hdl, #tg, #totalChol, #creatinine, #acr, #alt, #ast, #hb, #tsh, #ft4, #ft3"
        )
        .forEach((input) => {
          input.addEventListener("blur", function () {
            validateNumberInput(this, 0);
          });
        });

      // Toggle complications when "No complications" is checked
      function toggleComplications(checkbox) {
        const allComplications = document.querySelectorAll(
          ".complication:not(#noComplicationsCheckbox)"
        );

        if (checkbox.checked) {
          // Uncheck and disable all other complications
          allComplications.forEach((cb) => {
            cb.checked = false;
            cb.disabled = true;
            cb.parentElement.classList.add("disabled-checkbox");
          });
        } else {
          // Enable all other complications
          allComplications.forEach((cb) => {
            cb.disabled = false;
            cb.parentElement.classList.remove("disabled-checkbox");
          });
        }
      }

      // Show/hide insulin therapy section based on diabetes type
      function toggleInsulinTherapy() {
        const type1Checked = document.querySelector(
          '.diabetesType[value="Type 1"]'
        ).checked;
        const insulinTherapySection = document.getElementById(
          "insulinTherapySection"
        );

        if (type1Checked) {
          insulinTherapySection.style.display = "block";
          calculateTDD();
        } else {
          insulinTherapySection.style.display = "none";
        }
      }

      // Calculate Total Daily Dose (TDD) from current insulin medications
      function calculateTDD() {
        let tdd = 0;
        const medGroups = document.querySelectorAll(".medication-group");

        medGroups.forEach((group) => {
          const name = group.querySelector(".medication-name").value;
          const dose = group.querySelector(".medication-dose").value;

          if (name === "Insulin" && dose) {
            const doseValue = parseFloat(dose);
            const freq = group.querySelector(".medication-freq").value;

            if (freq === "Once daily") tdd += doseValue;
            else if (freq === "Twice daily") tdd += doseValue * 2;
            else if (freq === "Three times daily") tdd += doseValue * 3;
            else if (freq === "With meals") tdd += doseValue * 3; // Assuming 3 meals
            // Add other frequency calculations as needed
          }
        });

        document.getElementById("tddResult").textContent =
          tdd > 0 ? tdd + " units" : "Not calculated";

        // Calculate ICR and ISF if TDD is available
        if (tdd > 0) {
          const icr = Math.round(500 / tdd);
          const isf = Math.round(1800 / tdd);

          document.getElementById("icrResult").textContent =
            icr > 0 ? "1:" + icr : "Not calculated";
          document.getElementById("isfResult").textContent =
            isf > 0 ? isf + " mg/dL per unit" : "Not calculated";
        }
      }

      // Calculate eGFR using CKD-EPI 2021 formula
      function calculateEGFR() {
        let creatinine = parseFloat(
          document.getElementById("creatinine").value
        );
        const creatinineUnit = document.getElementById("creatinine-unit").value;
        const age = parseInt(document.getElementById("patientAge").value);
        const gender = document.getElementById("patientGender").value;

        // Convert creatinine to mg/dL if needed
        if (creatinineUnit === "μmol/L") {
          creatinine = creatinine / 88.4;
        }

        if (!creatinine || !age || !gender) {
          document.getElementById("egfr-result").textContent = "-";
          document.getElementById("egfr").value = "";
          return;
        }

        // CKD-EPI 2021 formula coefficients
        let k, a, sexCoeff;

        if (gender === "Female") {
          k = 0.7;
          a = -0.241;
          sexCoeff = 1.012;
        } else {
          k = 0.9;
          a = -0.302;
          sexCoeff = 1.0;
        }

        // Calculate eGFR
        const crRatio = Math.min(creatinine / k, 1);
        const egfr =
          142 *
          Math.pow(crRatio, a) *
          Math.pow(Math.max(creatinine / k, 1), -1.2) *
          Math.pow(0.9938, age) *
          sexCoeff;

        // Round to 1 decimal place
        const roundedEGFR = Math.round(egfr * 10) / 10;

        // Update display
        document.getElementById("egfr").value = roundedEGFR;

        // Add CKD stage classification
        let stage = "";
        if (egfr >= 90) stage = " (Stage G1)";
        else if (egfr >= 60) stage = " (Stage G2)";
        else if (egfr >= 45) stage = " (Stage G3a)";
        else if (egfr >= 30) stage = " (Stage G3b)";
        else if (egfr >= 15) stage = " (Stage G4)";
        else stage = " (Stage G5)";

        document.getElementById("egfr-result").textContent =
          roundedEGFR + stage;
      }

      // Update ACR category
      function updateACRCategory() {
        let acr = parseFloat(document.getElementById("acr").value);
        const acrUnit = document.getElementById("acr-unit").value;

        if (!acr) {
          document.getElementById("acr-category").textContent = "";
          return;
        }

        // Convert to mg/g if needed
        if (acrUnit === "mg/mmol") {
          acr = acr * 8.84;
        }

        let category = "";
        if (acr < 30) category = " (Normal)";
        else if (acr < 300) category = " (Moderately increased)";
        else category = " (Severely increased)";

        document.getElementById("acr-category").textContent = category;
      }

      // Unit conversion functions
      function convertHba1cToMmol(val) {
        return val ? (10.93 * val - 23.5).toFixed(1) + " mmol/mol" : "";
      }

      function convertGlucoseMgToMmol(val) {
        return val ? (val / 18).toFixed(1) + " mmol/L" : "";
      }

      function convertGlucoseMmolToMg(val) {
        return val ? (val * 18).toFixed(0) + " mg/dL" : "";
      }

      function convertCholMgToMmol(val) {
        return val ? (val / 38.67).toFixed(1) + " mmol/L" : "";
      }

      function convertCholMmolToMg(val) {
        return val ? (val * 38.67).toFixed(0) + " mg/dL" : "";
      }

      function convertTrigMgToMmol(val) {
        return val ? (val / 88.57).toFixed(1) + " mmol/L" : "";
      }

      function convertTrigMmolToMg(val) {
        return val ? (val * 88.57).toFixed(0) + " mg/dL" : "";
      }

      function convertCrMgToUmoll(val) {
        return val ? (val * 88.4).toFixed(0) + " μmol/L" : "";
      }

      function convertCrUmollToMg(val) {
        return val ? (val / 88.4).toFixed(2) + " mg/dL" : "";
      }

      function convertACRMgToMgmmol(val) {
        return val ? (val / 8.84).toFixed(1) + " mg/mmol" : "";
      }

      function convertACRMgmmolToMg(val) {
        return val ? (val * 8.84).toFixed(0) + " mg/g" : "";
      }

      function convertHbGdlToMmol(val) {
        return val ? (val * 0.6206).toFixed(1) + " mmol/L" : "";
      }

      function convertHbMmolToGdl(val) {
        return val ? (val / 0.6206).toFixed(1) + " g/dL" : "";
      }

      function convertFT4NgdlToPmol(val) {
        return val ? (val * 12.87).toFixed(1) + " pmol/L" : "";
      }

      function convertFT4PmolToNgdl(val) {
        return val ? (val / 12.87).toFixed(2) + " ng/dL" : "";
      }

      function convertFT3PgmlToPmol(val) {
        return val ? (val * 1.536).toFixed(1) + " pmol/L" : "";
      }

      function convertFT3PmolToPgml(val) {
        return val ? (val / 1.536).toFixed(1) + " pg/mL" : "";
      }

      // Unit conversion handlers
      function convertGlucoseUnits() {
        const fbs = parseFloat(document.getElementById("fbs").value);
        const unit = document.getElementById("fbs-unit").value;

        if (!fbs) {
          document.getElementById("fbs-converted").textContent = "";
          return;
        }

        if (unit === "mg/dL") {
          document.getElementById("fbs-converted").textContent =
            convertGlucoseMgToMmol(fbs);
        } else {
          document.getElementById("fbs-converted").textContent =
            convertGlucoseMmolToMg(fbs);
        }
      }

      function convertCreatinineUnits() {
        const creatinine = parseFloat(
          document.getElementById("creatinine").value
        );
        const unit = document.getElementById("creatinine-unit").value;

        if (!creatinine) {
          document.getElementById("creatinine-converted").textContent = "";
          return;
        }

        if (unit === "mg/dL") {
          document.getElementById("creatinine-converted").textContent =
            convertCrMgToUmoll(creatinine);
        } else {
          document.getElementById("creatinine-converted").textContent =
            convertCrUmollToMg(creatinine);
        }

        // Recalculate eGFR if creatinine changes
        calculateEGFR();
      }

      function convertACRUnits() {
        const acr = parseFloat(document.getElementById("acr").value);
        const unit = document.getElementById("acr-unit").value;

        if (!acr) {
          document.getElementById("acr-converted").textContent = "";
          return;
        }

        if (unit === "mg/g") {
          document.getElementById("acr-converted").textContent =
            convertACRMgToMgmmol(acr);
        } else {
          document.getElementById("acr-converted").textContent =
            convertACRMgmmolToMg(acr);
        }

        // Update ACR category
        updateACRCategory();
      }

      function convertHemoglobinUnits() {
        const hb = parseFloat(document.getElementById("hb").value);
        const unit = document.getElementById("hb-unit").value;

        if (!hb) {
          document.getElementById("hb-converted").textContent = "";
          return;
        }

        if (unit === "g/dL") {
          document.getElementById("hb-converted").textContent =
            convertHbGdlToMmol(hb);
        } else {
          document.getElementById("hb-converted").textContent =
            convertHbMmolToGdl(hb);
        }
      }

      function convertFT4Units() {
        const ft4 = parseFloat(document.getElementById("ft4").value);
        const unit = document.getElementById("ft4-unit").value;

        if (!ft4) {
          document.getElementById("ft4-converted").textContent = "";
          return;
        }

        if (unit === "ng/dL") {
          document.getElementById("ft4-converted").textContent =
            convertFT4NgdlToPmol(ft4);
        } else {
          document.getElementById("ft4-converted").textContent =
            convertFT4PmolToNgdl(ft4);
        }
      }

      function convertFT3Units() {
        const ft3 = parseFloat(document.getElementById("ft3").value);
        const unit = document.getElementById("ft3-unit").value;

        if (!ft3) {
          document.getElementById("ft3-converted").textContent = "";
          return;
        }

        if (unit === "pg/mL") {
          document.getElementById("ft3-converted").textContent =
            convertFT3PgmlToPmol(ft3);
        } else {
          document.getElementById("ft3-converted").textContent =
            convertFT3PmolToPgml(ft3);
        }
      }

      function convertLDLUnits() {
        const ldl = parseFloat(document.getElementById("ldl").value);
        const unit = document.getElementById("ldl-unit").value;

        if (!ldl) {
          document.getElementById("ldl-converted").textContent = "";
          return;
        }

        if (unit === "mg/dL") {
          document.getElementById("ldl-converted").textContent =
            convertCholMgToMmol(ldl);
        } else {
          document.getElementById("ldl-converted").textContent =
            convertCholMmolToMg(ldl);
        }
      }

      function convertHDLUnits() {
        const hdl = parseFloat(document.getElementById("hdl").value);
        const unit = document.getElementById("hdl-unit").value;

        if (!hdl) {
          document.getElementById("hdl-converted").textContent = "";
          return;
        }

        if (unit === "mg/dL") {
          document.getElementById("hdl-converted").textContent =
            convertCholMgToMmol(hdl);
        } else {
          document.getElementById("hdl-converted").textContent =
            convertCholMmolToMg(hdl);
        }
      }

      function convertTGUnits() {
        const tg = parseFloat(document.getElementById("tg").value);
        const unit = document.getElementById("tg-unit").value;

        if (!tg) {
          document.getElementById("tg-converted").textContent = "";
          return;
        }

        if (unit === "mg/dL") {
          document.getElementById("tg-converted").textContent =
            convertTrigMgToMmol(tg);
        } else {
          document.getElementById("tg-converted").textContent =
            convertTrigMmolToMg(tg);
        }
      }

      function convertTotalCholUnits() {
        const totalChol = parseFloat(
          document.getElementById("totalChol").value
        );
        const unit = document.getElementById("totalChol-unit").value;

        if (!totalChol) {
          document.getElementById("totalChol-converted").textContent = "";
          return;
        }

        if (unit === "mg/dL") {
          document.getElementById("totalChol-converted").textContent =
            convertCholMgToMmol(totalChol);
        } else {
          document.getElementById("totalChol-converted").textContent =
            convertCholMmolToMg(totalChol);
        }
      }

      // Medication database with updated Anti-Lipid options
      const medicationDB = {
        Metformin: {
          subtypes: ["Regular", "XR"],
          defaultDose: "500mg",
        },
        Insulin: {
          subtypes: ["Long-acting", "Short-acting", "Rapid-acting", "Premixed"],
          defaultDose: "Units",
        },
        "Long-acting": {
          subtypes: ["Glargine", "Degludec", "Detemir", "Soliqua"],
          defaultDose: "Units",
        },
        "Short-acting": {
          subtypes: ["Regular insulin"],
          defaultDose: "Units",
        },
        "Rapid-acting": {
          subtypes: ["Aspart", "Lispro", "Glulisine"],
          defaultDose: "Units",
        },
        Premixed: {
          subtypes: ["NPH", "Novomix", "Humalog 25%", "Humalog 50%"],
          defaultDose: "Units",
        },
        "GLP-1 RA": {
          subtypes: ["Liraglutide", "Dulaglutide", "Semaglutide"],
          defaultDose: "mg",
        },
        SGLT2i: {
          subtypes: ["Empagliflozin", "Dapagliflozin", "Canagliflozin"],
          defaultDose: "mg",
        },
        "DPP-4i": {
          subtypes: ["Sitagliptin", "Linagliptin", "Alogliptin"],
          defaultDose: "mg",
        },
        Sulfonylurea: {
          subtypes: ["Glibenclamide", "Gliclazide", "Glimepiride"],
          defaultDose: "mg",
        },
        TZD: {
          subtypes: ["Pioglitazone"],
          defaultDose: "mg",
        },
        ARB: {
          subtypes: [
            "Losartan",
            "Valsartan",
            "Irbesartan",
            "Candesartan",
            "Olmesartan",
            "Telmisartan",
          ],
          defaultDose: "mg",
        },
        ACEi: {
          subtypes: [
            "Lisinopril",
            "Enalapril",
            "Ramipril",
            "Perindopril",
            "Captopril",
          ],
          defaultDose: "mg",
        },
        CCB: {
          subtypes: ["Amlodipine", "Nifedipine", "Diltiazem", "Verapamil"],
          defaultDose: "mg",
        },
        "Beta Blocker": {
          subtypes: [
            "Metoprolol",
            "Atenolol",
            "Bisoprolol",
            "Carvedilol",
            "Nebivolol",
            "Propranolol",
          ],
          defaultDose: "mg",
        },
        Thiazide: {
          subtypes: ["Hydrochlorothiazide", "Chlorthalidone", "Indapamide"],
          defaultDose: "mg",
        },
        Aspirin: {
          subtypes: ["81mg", "325mg"],
          defaultDose: "mg",
        },
        Clopidogrel: {
          subtypes: [],
          defaultDose: "75mg",
        },
        "Anti-Lipid": {
          subtypes: ["Rosuvastatin", "Atorvastatin", "Ezetimibe", "Evolocumab"],
          defaultDose: "mg",
        },
        Levothyroxine: {
          subtypes: [],
          defaultDose: "mcg",
        },
        Other: {
          subtypes: [],
          defaultDose: "",
        },
      };

      // Tab functionality
      function openTab(evt, tabName) {
        var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tabcontent");
        for (i = 0; i < tabcontent.length; i++) {
          tabcontent[i].style.display = "none";
        }
        tablinks = document.getElementsByClassName("tablinks");
        for (i = 0; i < tablinks.length; i++) {
          tablinks[i].className = tablinks[i].className.replace(" active", "");
        }
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " active";
      }

      // Add new medication row
      function addMedication() {
        const container = document.getElementById("medication-container");
        const newGroup = document.createElement("div");
        newGroup.className = "medication-group";

        newGroup.innerHTML = `
          <div class="medication-row">
            <select class="medication-name" onchange="updateMedicationOptions(this)">
              <option value="">Select Medication</option>
              <option value="Metformin">Metformin</option>
              <option value="Insulin">Insulin</option>
              <option value="GLP-1 RA">GLP-1 RA</option>
              <option value="SGLT2i">SGLT2 Inhibitors</option>
              <option value="DPP-4i">DPP-4 Inhibitors</option>
              <option value="Sulfonylurea">Sulfonylurea</option>
              <option value="TZD">TZD (Thiazolidinediones)</option>
              <option value="ARB">ARB (Angiotensin Receptor Blocker)</option>
              <option value="ACEi">ACE Inhibitor</option>
              <option value="CCB">Calcium Channel Blocker</option>
              <option value="Beta Blocker">Beta Blocker</option>
              <option value="Thiazide">Thiazide Diuretic</option>
              <option value="Aspirin">Aspirin</option>
              <option value="Clopidogrel">Clopidogrel</option>
              <option value="Anti-Lipid">Anti-Lipid Medications</option>
              <option value="Levothyroxine">Levothyroxine</option>
              <option value="Other">Other</option>
            </select>
            
            <div class="medication-subtype-container">
              <select class="medication-subtype" style="display: none;">
                <option value="">Select Type</option>
              </select>
            </div>
            
            <input type="text" class="medication-dose" placeholder="Dose">
            
            <select class="medication-freq">
              <option value="">Frequency</option>
              <option value="Once daily">Once daily</option>
              <option value="Twice daily">Twice daily</option>
              <option value="Three times daily">Three times daily</option>
              <option value="With meals">With meals</option>
              <option value="At bedtime">At bedtime</option>
              <option value="Every 2 weeks">Every 2 weeks</option>
              <option value="Other">Other</option>
            </select>
            
            <button class="remove-med-btn" onclick="removeMedication(this)">
              Remove
            </button>
          </div>
        `;

        container.appendChild(newGroup);
      }

      // Remove medication row
      function removeMedication(button) {
        const container = document.getElementById("medication-container");
        if (container.children.length > 1) {
          button.closest(".medication-group").remove();
        } else {
          alert("At least one medication row must remain");
        }
      }

      // Add family history member
      function addFamilyMember() {
        const container = document.getElementById("familyHistoryContainer");
        const newMember = document.createElement("div");
        newMember.className = "family-member";
        newMember.innerHTML = `
          <select class="family-relation">
            <option value="">Select family member</option>
            <option value="Mother">Mother</option>
            <option value="Father">Father</option>
            <option value="Sibling">Sibling</option>
            <option value="Grandparent">Grandparent</option>
            <option value="Aunt/Uncle">Aunt/Uncle</option>
            <option value="Child">Child</option>
          </select>
          <select class="family-diabetes-type">
            <option value="">Type of diabetes</option>
            <option value="Type 1">Type 1</option>
            <option value="Type 2">Type 2</option>
            <option value="GDM">GDM</option>
            <option value="Other">Other</option>
          </select>
          <input type="text" class="family-age-diagnosis" placeholder="Age at diagnosis" style="width: 120px;">
          <button class="remove-med-btn" onclick="removeFamilyMember(this)">
            Remove
          </button>
        `;
        container.appendChild(newMember);
      }

      // Remove family history member
      function removeFamilyMember(button) {
        const container = document.getElementById("familyHistoryContainer");
        if (container.children.length > 1) {
          button.closest(".family-member").remove();
        } else {
          alert("At least one family member must remain");
        }
      }

      // Updated function to set default frequencies for specific medications
      function updateMedicationOptions(select) {
        const medication = select.value;
        const row = select.closest(".medication-row");
        const subtypeContainer = row.querySelector(
          ".medication-subtype-container"
        );
        const doseInput = row.querySelector(".medication-dose");
        const freqSelect = row.querySelector(".medication-freq");

        // Clear previous subtype dropdowns
        subtypeContainer.innerHTML =
          '<select class="medication-subtype" style="display: none;"><option value="">Select Type</option></select>';

        // Reset and hide subtype if no medication selected
        if (!medication || medication === "Other") {
          subtypeContainer.querySelector(".medication-subtype").style.display =
            "none";
          doseInput.placeholder = "Dose";
          resetFrequencyOptions(freqSelect);
          return;
        }

        // Set default dose placeholder
        doseInput.placeholder = medicationDB[medication].defaultDose || "Dose";

        // Special handling for insulin
        if (medication === "Insulin") {
          createInsulinSubtypeDropdowns(
            subtypeContainer,
            medicationDB[medication].subtypes
          );
        } else {
          // Standard medication handling
          const subtypeSelect = subtypeContainer.querySelector(
            ".medication-subtype"
          );
          subtypeSelect.innerHTML = '<option value="">Select Type</option>';

          medicationDB[medication].subtypes.forEach((subtype) => {
            subtypeSelect.innerHTML += `<option value="${subtype}">${subtype}</option>`;
          });

          if (medicationDB[medication].subtypes.length > 0) {
            subtypeSelect.style.display = "inline-block";
          } else {
            subtypeSelect.style.display = "none";
          }
        }

        // Set default frequency for specific medications
        if (medication === "GLP-1 RA") {
          const subtypeSelect = subtypeContainer.querySelector(
            ".medication-subtype"
          );
          subtypeSelect.addEventListener("change", function () {
            const subtype = this.value;
            if (subtype === "Semaglutide" || subtype === "Dulaglutide") {
              freqSelect.innerHTML = `
                <option value="Once weekly" selected>Once weekly</option>
                <option value="Other">Other</option>
              `;
            } else if (subtype === "Liraglutide") {
              freqSelect.innerHTML = `
                <option value="Once daily" selected>Once daily</option>
                <option value="Other">Other</option>
              `;
            } else {
              resetFrequencyOptions(freqSelect);
            }
          });
        } else if (medication === "Anti-Lipid") {
          const subtypeSelect = subtypeContainer.querySelector(
            ".medication-subtype"
          );
          subtypeSelect.addEventListener("change", function () {
            const subtype = this.value;
            if (subtype === "Evolocumab") {
              freqSelect.innerHTML = `
                <option value="Every 2 weeks" selected>Every 2 weeks</option>
                <option value="Other">Other</option>
              `;
            } else {
              resetFrequencyOptions(freqSelect);
            }
          });
        } else {
          resetFrequencyOptions(freqSelect);
        }
      }

      // Reset to standard frequency options
      function resetFrequencyOptions(select) {
        select.innerHTML = `
          <option value="">Frequency</option>
          <option value="Once daily">Once daily</option>
          <option value="Twice daily">Twice daily</option>
          <option value="Three times daily">Three times daily</option>
          <option value="With meals">With meals</option>
          <option value="At bedtime">At bedtime</option>
          <option value="Once weekly">Once weekly</option>
          <option value="Every 2 weeks">Every 2 weeks</option>
          <option value="Other">Other</option>
        `;
      }

      // Create nested dropdowns for insulin types
      function createInsulinSubtypeDropdowns(container, subtypes) {
        container.innerHTML = ""; // Clear previous dropdowns

        // First level dropdown (insulin types)
        const firstLevelSelect = document.createElement("select");
        firstLevelSelect.className = "medication-subtype";
        firstLevelSelect.innerHTML =
          '<option value="">Select Insulin Type</option>';

        subtypes.forEach((type) => {
          firstLevelSelect.innerHTML += `<option value="${type}">${type}</option>`;
        });

        container.appendChild(firstLevelSelect);

        // Second level dropdown (specific insulin)
        const secondLevelSelect = document.createElement("select");
        secondLevelSelect.className = "medication-subtype";
        secondLevelSelect.style.display = "none";
        secondLevelSelect.innerHTML =
          '<option value="">Select Specific Insulin</option>';
        container.appendChild(secondLevelSelect);

        // Show/hide second level based on first level selection
        firstLevelSelect.addEventListener("change", function () {
          const selectedType = this.value;
          secondLevelSelect.style.display = "none";
          secondLevelSelect.innerHTML =
            '<option value="">Select Specific Insulin</option>';

          if (selectedType && medicationDB[selectedType]) {
            medicationDB[selectedType].subtypes.forEach((subtype) => {
              secondLevelSelect.innerHTML += `<option value="${subtype}">${subtype}</option>`;
            });
            secondLevelSelect.style.display = "inline-block";
          }
        });
      }

      // Add new medication to plan
      function addNewMedication() {
        const container = document.getElementById("newMeds-container");
        const newGroup = document.createElement("div");
        newGroup.className = "medication-group";

        newGroup.innerHTML = `
          <div class="medication-row">
            <select class="medication-name" onchange="updateMedicationOptions(this)">
              <option value="">Select Medication</option>
              <option value="Metformin">Metformin</option>
              <option value="Insulin">Insulin</option>
              <option value="GLP-1 RA">GLP-1 RA</option>
              <option value="SGLT2i">SGLT2 Inhibitors</option>
              <option value="DPP-4i">DPP-4 Inhibitors</option>
              <option value="Sulfonylurea">Sulfonylurea</option>
              <option value="TZD">TZD (Thiazolidinediones)</option>
              <option value="ARB">ARB (Angiotensin Receptor Blocker)</option>
              <option value="ACEi">ACE Inhibitor</option>
              <option value="CCB">Calcium Channel Blocker</option>
              <option value="Beta Blocker">Beta Blocker</option>
              <option value="Thiazide">Thiazide Diuretic</option>
              <option value="Aspirin">Aspirin</option>
              <option value="Clopidogrel">Clopidogrel</option>
              <option value="Anti-Lipid">Anti-Lipid Medications</option>
              <option value="Levothyroxine">Levothyroxine</option>
              <option value="Other">Other</option>
            </select>
            
            <div class="medication-subtype-container">
              <select class="medication-subtype" style="display: none;">
                <option value="">Select Type</option>
              </select>
            </div>
            
            <input type="text" class="medication-dose" placeholder="Dose">
            
            <select class="medication-freq">
              <option value="">Frequency</option>
              <option value="Once daily">Once daily</option>
              <option value="Twice daily">Twice daily</option>
              <option value="Three times daily">Three times daily</option>
              <option value="With meals">With meals</option>
              <option value="At bedtime">At bedtime</option>
              <option value="Every week">Every week</option>
              <option value="Every 2 weeks">Every 2 weeks</option>
              <option value="Other">Other</option>
            </select>

            <select class="medication-status">
              <option value="Continue">Continue</option>
              <option value="Discontinue">Discontinue</option>
              <option value="Increase Dose">Increase Dose</option>
              <option value="Decrease Dose">Decrease Dose</option>
              <option value="Change Frequency">Change Frequency</option>
            </select>
            
            <button class="remove-med-btn" onclick="removeNewMedication(this)">
              Remove
            </button>
          </div>
        `;

        container.appendChild(newGroup);
      }

      function removeNewMedication(button) {
        const container = document.getElementById("newMeds-container");
        if (container.children.length > 1) {
          button.closest(".medication-group").remove();
        } else {
          alert("At least one medication row must remain");
        }
      }

      // Populate treatment plan with current medications
      function populateFromCurrentMeds() {
        const currentMeds = document.querySelectorAll(
          "#medication-container .medication-group"
        );
        const newMedsContainer = document.getElementById("newMeds-container");

        // Clear existing new medications
        newMedsContainer.innerHTML = "";

        currentMeds.forEach((med) => {
          const name = med.querySelector(".medication-name").value;
          if (!name) return;

          addNewMedication();
          const newMed = newMedsContainer.lastElementChild;

          // Copy values
          newMed.querySelector(".medication-name").value = name;
          updateMedicationOptions(newMed.querySelector(".medication-name"));

          const subtype = med.querySelector(".medication-subtype").value;
          if (subtype) {
            newMed.querySelector(".medication-subtype").value = subtype;
          }

          newMed.querySelector(".medication-dose").value =
            med.querySelector(".medication-dose").value;
          newMed.querySelector(".medication-freq").value =
            med.querySelector(".medication-freq").value;

          // Default to "Continue"
          newMed.querySelector(".medication-status").value = "Continue";
        });
      }

      // Auto-calculate BMI
      function calculateBMI() {
        const weight = parseFloat(document.getElementById("weight").value);
        const height = parseFloat(document.getElementById("height").value);

        if (weight && height) {
          // Convert height from cm to meters
          const heightInMeters = height / 100;
          const bmi = (weight / (heightInMeters * heightInMeters)).toFixed(1);
          document.getElementById("bmi").value = bmi;

          // Add BMI classification
          let classification = "";
          if (bmi < 18.5) classification = " (Underweight)";
          else if (bmi >= 18.5 && bmi < 25) classification = " (Normal)";
          else if (bmi >= 25 && bmi < 30) classification = " (Overweight)";
          else classification = " (Obese)";

          document.getElementById("bmiResult").textContent =
            bmi + classification;
        }
      }

      // Generate the note
      function generateNote() {
        let note = "DIABETES PROGRESS NOTE TEDC\n\n";

        // History
        note += "=== HISTORY ===\n";
        note += `Age: ${
          document.getElementById("patientAge").value || "Not specified"
        }\n`;
        note += `Gender: ${
          document.getElementById("patientGender").value || "Not specified"
        }\n`;

        // Female-specific details
        if (document.getElementById("patientGender").value === "Female") {
          const femaleDetails = [];
          if (document.getElementById("isMarried").checked)
            femaleDetails.push("Married");
          if (document.getElementById("isPregnant").checked)
            femaleDetails.push("Pregnant");
          if (document.getElementById("isLactating").checked)
            femaleDetails.push("Lactating");
          if (document.getElementById("planningPregnancy").checked)
            femaleDetails.push("Planning Pregnancy");

          if (femaleDetails.length > 0) {
            note += `Female-Specific Details: ${femaleDetails.join(", ")}\n`;
          }
        }

        note += `Duration of Diagnosis: ${
          document.getElementById("diagnosisDuration").value || "Not specified"
        }\n`;

        // Diabetes Type
        const diabetesTypes = [];
        document.querySelectorAll(".diabetesType:checked").forEach((cb) => {
          if (cb.value === "Other") {
            diabetesTypes.push(
              document.getElementById("diabetesTypeOther").value
            );
          } else {
            diabetesTypes.push(cb.value);
          }
        });
        note += `Diabetes Type: ${
          diabetesTypes.length > 0 ? diabetesTypes.join(", ") : "Not specified"
        }\n`;

        // Other Medical History
        const otherHistory = [];
        document.querySelectorAll(".otherHistory:checked").forEach((cb) => {
          if (cb.value === "Other") {
            otherHistory.push(
              document.getElementById("otherHistoryText").value
            );
          } else {
            otherHistory.push(cb.value);
          }
        });
        note += `Other Medical History: ${
          otherHistory.length > 0 ? otherHistory.join(", ") : "None"
        }\n\n`;

        // Family History
        note += "=== FAMILY HISTORY ===\n";
        const familyMembers = document.querySelectorAll(".family-member");
        let hasFamilyHistory = false;

        familyMembers.forEach((member) => {
          const relation = member.querySelector(".family-relation").value;
          const type = member.querySelector(".family-diabetes-type").value;
          const age = member.querySelector(".family-age-diagnosis").value;

          if (relation && type) {
            hasFamilyHistory = true;
            note += `• ${relation}: ${type}`;
            if (age) note += ` (diagnosed at age ${age})`;
            note += "\n";
          }
        });

        if (!hasFamilyHistory) note += "No significant family history\n";
        note += "\n";

        // Complications
        note += "=== COMPLICATIONS ===\n";

        // Check if "No complications" is selected
        const noComplicationsChecked = document.getElementById(
          "noComplicationsCheckbox"
        ).checked;
        if (noComplicationsChecked) {
          note += "No complications\n\n";
        } else {
          const complications = [];
          document
            .querySelectorAll(
              ".complication:checked:not(#noComplicationsCheckbox)"
            )
            .forEach((cb) => {
              if (cb.value === "Other") {
                complications.push(
                  document.getElementById("complicationOther").value
                );
              } else {
                complications.push(cb.value);
              }
            });
          note += `${
            complications.length > 0
              ? complications.join(", ")
              : "No documented complications"
          }\n\n`;
        }

        // Hypoglycemia History
        note += "=== HYPOGLYCEMIA HISTORY ===\n";

        // Frequency
        const hypoFrequency = document.querySelector(
          'input[name="hypoFrequency"]:checked'
        );
        note += `Frequency: ${
          hypoFrequency ? hypoFrequency.value : "Not specified"
        }\n`;

        // Symptoms
        const hypoSymptoms = document.querySelector(
          'input[name="hypoSymptoms"]:checked'
        );
        note += `Presence of Symptoms: ${
          hypoSymptoms ? hypoSymptoms.value : "Not specified"
        }\n`;

        // Timing
        const hypoTiming = [];
        document.querySelectorAll(".hypoTiming:checked").forEach((cb) => {
          hypoTiming.push(cb.value);
        });
        note += `Timing: ${
          hypoTiming.length > 0 ? hypoTiming.join(", ") : "Not specified"
        }\n\n`;

        // Current Medications
        note += "=== CURRENT MEDICATIONS ===\n";
        const medGroups = document.querySelectorAll(".medication-group");
        let hasMeds = false;

        medGroups.forEach((group) => {
          const name = group.querySelector(".medication-name").value;
          if (!name) return;

          hasMeds = true;
          const subtype = group.querySelector(".medication-subtype").value;
          const dose = group.querySelector(".medication-dose").value;
          const freq = group.querySelector(".medication-freq").value;

          note += `• ${name}`;
          if (subtype) note += ` (${subtype})`;
          if (dose) note += ` ${dose}`;
          if (freq) note += ` ${freq}`;
          note += "\n";
        });

        if (!hasMeds) note += "No current medications\n";
        note += "\n";

        // Insulin Therapy Details
        if (document.querySelector('.diabetesType[value="Type 1"]').checked) {
          note += "=== INSULIN THERAPY DETAILS ===\n";

          // Carb counting
          const carbCounting = document.getElementById("carbCounting").checked;
          note += `• Carb Counting: ${carbCounting ? "Yes" : "No"}\n`;

          if (carbCounting) {
            const customICR = document.getElementById("customICR").value;
            const icr =
              customICR || document.getElementById("icrResult").textContent;
            note += `• ICR: ${icr}\n`;
          }

          // ISF
          const customISF = document.getElementById("customISF").value;
          const isf =
            customISF || document.getElementById("isfResult").textContent;
          note += `• ISF: ${isf}\n`;

          // TDD
          note += `• TDD: ${
            document.getElementById("tddResult").textContent
          }\n`;

          // Injection timing
          const injectionTiming = document.querySelector(
            'input[name="injectionTiming"]:checked'
          );
          note += `• Injection Timing: ${
            injectionTiming ? injectionTiming.value : "Not specified"
          }\n`;

          // Technique
          const technique = document.getElementById("injectionTechnique").value;
          if (technique) note += `• Injection Technique: ${technique}\n`;
        }

        // Screening History
        note += "=== SCREENING HISTORY ===\n";
        const footScreening = document.querySelector(
          'input[name="footScreening"]:checked'
        );
        note += `Foot Screening: ${
          footScreening ? footScreening.value : "Not specified"
        }\n`;

        const retinaScreening = document.querySelector(
          'input[name="retinaScreening"]:checked'
        );
        note += `Retina Screening: ${
          retinaScreening ? retinaScreening.value : "Not specified"
        }\n`;

        const kidneyScreening = document.querySelector(
          'input[name="kidneyScreening"]:checked'
        );
        note += `Kidney Screening: ${
          kidneyScreening ? kidneyScreening.value : "Not specified"
        }\n\n`;

        // Lifestyle History
        note += "=== LIFESTYLE HISTORY ===\n";
        const smokingStatus = document.querySelector(
          'input[name="smokingStatus"]:checked'
        );
        note += `Smoking Status: ${
          smokingStatus ? smokingStatus.value : "Not specified"
        }\n`;

        const treatmentAdherence = document.querySelector(
          'input[name="treatmentAdherence"]:checked'
        );
        note += `Adherence on Treatment: ${
          treatmentAdherence ? treatmentAdherence.value : "Not specified"
        }\n`;

        const diet = document.querySelector('input[name="diet"]:checked');
        note += `Diet: ${diet ? diet.value : "Not specified"}\n`;

        const physicalActivity = document.querySelector(
          'input[name="physicalActivity"]:checked'
        );
        note += `Physical Activity: ${
          physicalActivity ? physicalActivity.value : "Not specified"
        }\n`;

        const vaccinationStatus = document.querySelector(
          'input[name="vaccinationStatus"]:checked'
        );
        note += `Vaccination Status: ${
          vaccinationStatus ? vaccinationStatus.value : "Not specified"
        }\n\n`;

        // Examination
        note += "=== EXAMINATION ===\n";
        note += `Weight: ${
          document.getElementById("weight").value || "Not measured"
        } kg\n`;
        note += `Height: ${
          document.getElementById("height").value || "Not measured"
        } cm\n`;
        note += `BMI: ${
          document.getElementById("bmi").value || "Not calculated"
        } ${
          document
            .getElementById("bmiResult")
            .textContent.includes("Underweight")
            ? "(Underweight)"
            : document
                .getElementById("bmiResult")
                .textContent.includes("Normal")
            ? "(Normal)"
            : document
                .getElementById("bmiResult")
                .textContent.includes("Overweight")
            ? "(Overweight)"
            : document.getElementById("bmiResult").textContent.includes("Obese")
            ? "(Obese)"
            : ""
        }\n`;
        note += `Blood Pressure: ${
          document.getElementById("bp").value || "Not measured"
        }\n\n`;

        // Investigations
        note += "=== INVESTIGATIONS ===\n";

        // Lab Results
        note += "Laboratory Results:\n";
        if (document.getElementById("hba1c").value) {
          note += `• HbA1c: ${
            document.getElementById("hba1c").value
          }% (${convertHba1cToMmol(document.getElementById("hba1c").value)})\n`;
        }

        if (document.getElementById("fbs").value) {
          const fbs = document.getElementById("fbs").value;
          const fbsUnit = document.getElementById("fbs-unit").value;
          if (fbsUnit === "mg/dL") {
            note += `• FBS: ${fbs} mg/dL (${convertGlucoseMgToMmol(fbs)})\n`;
          } else {
            note += `• FBS: ${fbs} mmol/L (${convertGlucoseMmolToMg(fbs)})\n`;
          }
        }

        // Renal Function
        note += "\nRenal Function:\n";
        if (document.getElementById("creatinine").value) {
          const creatinine = document.getElementById("creatinine").value;
          const creatinineUnit =
            document.getElementById("creatinine-unit").value;
          if (creatinineUnit === "mg/dL") {
            note += `• Creatinine: ${creatinine} mg/dL (${convertCrMgToUmoll(
              creatinine
            )})\n`;
          } else {
            note += `• Creatinine: ${creatinine} μmol/L (${convertCrUmollToMg(
              creatinine
            )})\n`;
          }
        }
        if (document.getElementById("egfr").value) {
          note += `• eGFR (CKD-EPI 2021): ${
            document.getElementById("egfr").value
          } mL/min/1.73m²\n`;
        }
        if (document.getElementById("acr").value) {
          const acr = document.getElementById("acr").value;
          const acrUnit = document.getElementById("acr-unit").value;
          if (acrUnit === "mg/g") {
            note += `• ACR: ${acr} mg/g (${convertACRMgToMgmmol(acr)})\n`;
          } else {
            note += `• ACR: ${acr} mg/mmol (${convertACRMgmmolToMg(acr)})\n`;
          }
        }

        // Liver Function
        note += "\nLiver Function:\n";
        if (document.getElementById("alt").value) {
          note += `• ALT: ${document.getElementById("alt").value} U/L\n`;
        }
        if (document.getElementById("ast").value) {
          note += `• AST: ${document.getElementById("ast").value} U/L\n`;
        }

        // Hematology
        if (document.getElementById("hb").value) {
          const hb = document.getElementById("hb").value;
          const hbUnit = document.getElementById("hb-unit").value;
          if (hbUnit === "g/dL") {
            note += `\nHemoglobin: ${hb} g/dL (${convertHbGdlToMmol(hb)})\n`;
          } else {
            note += `\nHemoglobin: ${hb} mmol/L (${convertHbMmolToGdl(hb)})\n`;
          }
        }

        // Thyroid Function
        note += "\nThyroid Function:\n";
        if (document.getElementById("tsh").value) {
          note += `• TSH: ${document.getElementById("tsh").value} mIU/L\n`;
        }
        if (document.getElementById("ft4").value) {
          const ft4 = document.getElementById("ft4").value;
          const ft4Unit = document.getElementById("ft4-unit").value;
          if (ft4Unit === "ng/dL") {
            note += `• FT4: ${ft4} ng/dL (${convertFT4NgdlToPmol(ft4)})\n`;
          } else {
            note += `• FT4: ${ft4} pmol/L (${convertFT4PmolToNgdl(ft4)})\n`;
          }
        }
        if (document.getElementById("ft3").value) {
          const ft3 = document.getElementById("ft3").value;
          const ft3Unit = document.getElementById("ft3-unit").value;
          if (ft3Unit === "pg/mL") {
            note += `• FT3: ${ft3} pg/mL (${convertFT3PgmlToPmol(ft3)})\n`;
          } else {
            note += `• FT3: ${ft3} pmol/L (${convertFT3PmolToPgml(ft3)})\n`;
          }
        }

        // Lipid Profile
        note += "\nLipid Profile:\n";
        if (document.getElementById("ldl").value) {
          const ldl = document.getElementById("ldl").value;
          const ldlUnit = document.getElementById("ldl-unit").value;
          if (ldlUnit === "mg/dL") {
            note += `• LDL: ${ldl} mg/dL (${convertCholMgToMmol(ldl)})\n`;
          } else {
            note += `• LDL: ${ldl} mmol/L (${convertCholMmolToMg(ldl)})\n`;
          }
        }
        if (document.getElementById("hdl").value) {
          const hdl = document.getElementById("hdl").value;
          const hdlUnit = document.getElementById("hdl-unit").value;
          if (hdlUnit === "mg/dL") {
            note += `• HDL: ${hdl} mg/dL (${convertCholMgToMmol(hdl)})\n`;
          } else {
            note += `• HDL: ${hdl} mmol/L (${convertCholMmolToMg(hdl)})\n`;
          }
        }
        if (document.getElementById("tg").value) {
          const tg = document.getElementById("tg").value;
          const tgUnit = document.getElementById("tg-unit").value;
          if (tgUnit === "mg/dL") {
            note += `• TG: ${tg} mg/dL (${convertTrigMgToMmol(tg)})\n`;
          } else {
            note += `• TG: ${tg} mmol/L (${convertTrigMmolToMg(tg)})\n`;
          }
        }
        if (document.getElementById("totalChol").value) {
          const totalChol = document.getElementById("totalChol").value;
          const totalCholUnit = document.getElementById("totalChol-unit").value;
          if (totalCholUnit === "mg/dL") {
            note += `• Total Cholesterol: ${totalChol} mg/dL (${convertCholMgToMmol(
              totalChol
            )})\n`;
          } else {
            note += `• Total Cholesterol: ${totalChol} mmol/L (${convertCholMmolToMg(
              totalChol
            )})\n`;
          }
        }

        // Radiology
        if (document.getElementById("radiology").value) {
          note += `\nRadiology Reports:\n${
            document.getElementById("radiology").value
          }\n`;
        }

        note += "\n";

        // Assessment and Plan
        note += "=== ASSESSMENT AND PLAN ===\n";

        // Assessment
        note += "Assessment:\n";
        const glycemicStatus = document.querySelector(
          'input[name="glycemicStatus"]:checked'
        );
        note += `Glycemic Status: ${
          glycemicStatus ? glycemicStatus.value : "Not specified"
        }\n\n`;

        // Plan
        note += "Plan:\n\nMedications:\n";
        const newMedGroups = document.querySelectorAll(
          "#newMeds-container .medication-group"
        );
        let hasNewMeds = false;

        newMedGroups.forEach((group) => {
          const name = group.querySelector(".medication-name").value;
          if (!name) return;

          hasNewMeds = true;
          const subtype = group.querySelector(".medication-subtype").value;
          const dose = group.querySelector(".medication-dose").value;
          const freq = group.querySelector(".medication-freq").value;
          const status = group.querySelector(".medication-status").value;

          // Format based on status
          switch (status) {
            case "Continue":
              note += `• Continue ${name}`;
              if (subtype) note += ` (${subtype})`;
              if (dose) note += ` at current dose of ${dose}`;
              if (freq) note += ` ${freq}`;
              break;
            case "Discontinue":
              note += `• Discontinue ${name}`;
              if (subtype) note += ` (${subtype})`;
              break;
            case "Increase Dose":
              note += `• Increase dose of ${name}`;
              if (subtype) note += ` (${subtype})`;
              if (dose) note += ` to ${dose}`;
              if (freq) note += ` ${freq}`;
              break;
            case "Decrease Dose":
              note += `• Decrease dose of ${name}`;
              if (subtype) note += ` (${subtype})`;
              if (dose) note += ` to ${dose}`;
              if (freq) note += ` ${freq}`;
              break;
            case "Change Frequency":
              note += `• Change frequency of ${name}`;
              if (subtype) note += ` (${subtype})`;
              if (dose) note += ` (current dose ${dose})`;
              if (freq) note += ` to ${freq}`;
              break;
          }
          note += "\n";
        });

        if (!hasNewMeds) note += "No medication changes\n";

        // Lifestyle
        const lifestyle = [];
        document.querySelectorAll(".lifestyle:checked").forEach((cb) => {
          if (cb.value === "Other") {
            lifestyle.push(document.getElementById("lifestyleOther").value);
          } else {
            lifestyle.push(cb.value);
          }
        });
        note += `\nLifestyle Recommendations: ${
          lifestyle.length > 0 ? lifestyle.join(", ") : "None"
        }\n`;

        // Doctor Recommendations
        if (document.getElementById("doctorRecommendations").value) {
          note += `\nDoctor Recommendations:\n${
            document.getElementById("doctorRecommendations").value
          }\n`;
        }

        // Orders and Referrals
        const referrals = [];
        document.querySelectorAll(".referral:checked").forEach((cb) => {
          referrals.push(cb.value);
        });
        if (referrals.length > 0) {
          note += `\nOrders and Referrals:\n• ${referrals.join("\n• ")}\n`;
        }

        // Educator Instructions
        const educatorInstructions = [];
        document
          .querySelectorAll(".educatorInstruction:checked")
          .forEach((cb) => {
            educatorInstructions.push(cb.value);
          });
        if (educatorInstructions.length > 0) {
          note += `\nInstructions to Educator:\n• ${educatorInstructions.join(
            "\n• "
          )}\n`;
        }

        // Nutritionist Instructions
        const nutritionistInstructions = [];
        document
          .querySelectorAll(".nutritionistInstruction:checked")
          .forEach((cb) => {
            nutritionistInstructions.push(cb.value);
          });
        if (nutritionistInstructions.length > 0) {
          note += `\nNutritionist Instructions:\n• ${nutritionistInstructions.join(
            "\n• "
          )}\n`;
        }

        document.getElementById("progressNote").value = note;
      }

      // Add event listeners for diabetes type changes
      document.querySelectorAll(".diabetesType").forEach((checkbox) => {
        checkbox.addEventListener("change", toggleInsulinTherapy);
      });

      // Add event listener for carb counting checkbox
      document
        .getElementById("carbCounting")
        .addEventListener("change", function () {
          document.getElementById("carbCountingDetails").style.display = this
            .checked
            ? "block"
            : "none";
        });

      // Add event listeners for insulin medication changes
      document
        .getElementById("medication-container")
        .addEventListener("change", function (e) {
          if (
            e.target.classList.contains("medication-name") ||
            e.target.classList.contains("medication-dose") ||
            e.target.classList.contains("medication-freq")
          ) {
            calculateTDD();
          }
        });
    </script>
  </body>
</html>
